(common) {
  errors
  log
  reload
  loadbalance
  cache 300
  loop
  local
  hosts {
    192.168.10.11 pve01.{{ SECRET_DOMAIN }}
    192.168.10.15 tower.{{ SECRET_DOMAIN }}
    192.168.10.21 minio.{{ SECRET_DOMAIN }}
    192.168.10.31 k3s-ma-01.{{ SECRET_DOMAIN }}
    192.168.10.32 k3s-ma-02.{{ SECRET_DOMAIN }}
    192.168.10.33 k3s-ma-03.{{ SECRET_DOMAIN }}
    192.168.10.41 k3s-wo-01.{{ SECRET_DOMAIN }}
    ttl 600
    reload 5s
    fallthrough
  }
  prometheus 192.168.10.1:9153
}

. {
  bind 192.168.10.1 127.0.0.1 ::1
  import common
  k8s_gateway {{ SECRET_DOMAIN }} {
    resources Ingress
    ttl 1
    kubeconfig /usr/local/etc/coredns/kubeconfig
    fallthrough
  }
  forward . tls://1.1.1.1 tls://1.0.0.1 {
    tls_servername cloudflare-dns.com
  }
}
